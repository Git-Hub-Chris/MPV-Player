language: c

_macbase:
  - &macOld
    os: osx
    compiler: clang
    env:
      - HOMEBREW_NO_AUTO_UPDATE=1
      - HOMEBREW_NO_INSTALL_CLEANUP=1
  - &macNew
    <<: *macOld
    addons:
      homebrew:
        packages: ['autoconf', 'automake', 'ffmpeg', 'freetype', 'fribidi',
                   'libass', 'libtool', 'little-cms2', 'luajit', 'nasm',
                   'pkg-config', 'python']
        update: true

matrix:
  include:
    - os: linux
      compiler: clang
      addons:
        apt:
          # basics
          - build-essential
          - curl
          - git
          - pkg-config

          # libass deps
          - libfreetype6-dev
          - libfribidi-dev
          - libharfbuzz-dev
          - libfontconfig1-dev
          - libpng-dev

          # FFmpeg deps
          - libgnutls28-dev
          - libva-dev
          - libvdpau-dev

          # mpv deps
          - libarchive-dev
          - libasound2-dev
          - libbluray-dev
          - libdrm-dev
          - libegl1-mesa-dev
          - libgl1-mesa-dev
          - libgbm-dev
          - liblcms2-dev
          - libpulse-dev
          - libwayland-dev
          - libx11-dev
          - x11proto-dev
          - libxinerama-dev
          - libxkbcommon-dev
          - libxrandr-dev
          - libxss-dev
          - libluajit-5.1-dev
  fast_finish: true

dist: bionic
services:
  - docker

env:
  global:
    # Coverity token
    - secure: "H21mSRlMhk4BKS0xHZvCFGJxteCP0hRVUxTuNfM2Z9HBsyutuLEYMtViLO86VtM+Tqla3xXPzUdS4ozLwI72Ax/5ZUDXACROj73yW6QhFB5D6rLut12+FjqC7M33Qv2hl0xwgNBmR5dsm1ToP37+Wn+ecJQNvN8fkTXF+HVzOEw="
    # Travis token for mpv.io
    - secure: "nlTVLJK6kRhtXvhKCoJ3YdFGHuKaq/eHowfPw25hqRWuBOZd+HjHY5KIYjV7SxuKFDpJE4GpNcvA3Q31nsqomxpkLYgrwjg6TSazN7ZP+x85ZgV1QGFebrPfGm2n5UR5CAPAwFoeF3pZheLi4bajVzwq1fWW+x3grS188P9OZso="

branches:
  only:
    - master
    - ci
    - coverity_scan
    - /release\/.*$/

before_install:
  - if [ "$TRAVIS_COMPILER" = "clang" ]; then export CXX="clang++"; fi
  - if [ "$TRAVIS_COMPILER" = "gcc" ]; then export CXX="g++"; fi
  - |
      if [ "$TRAVIS_OS_NAME" = "linux" ]; then
         WL_PROTOCOLS_DEB_NAME="wayland-protocols_1.20-1_all.deb";
         curl -LO "http://archive.ubuntu.com/ubuntu/pool/main/w/wayland-protocols/${WL_PROTOCOLS_DEB_NAME}";
         SHASUM=$(sha256sum "${WL_PROTOCOLS_DEB_NAME}" |awk '{print $1}');
         EXPECTED_SHASUM="4b8b41972cdf5269cdcd964d636d3ee15824ebf58cea79a952fe7a773af71af6";
         if [ "$SHASUM" != "$EXPECTED_SHASUM" ]; then exit 1; fi
         sudo apt install -y "./${WL_PROTOCOLS_DEB_NAME}";

         MPV_SYSROOT_TARBALL="2020-05-21-mpv_sysroot.tar.xz";
         curl -LO "https://megumin.fushizen.eu/builds/2020-05-21-mpv_sysroot.tar.xz";
         SHASUM=$(sha256sum "${MPV_SYSROOT_TARBALL}" |awk '{print $1}');
         EXPECTED_SHASUM="297461ef689402dd1c63cbcf255aeed59b90d06f742a8784156284fa73d4610a";
         if [ "$SHASUM" != "$EXPECTED_SHASUM" ]; then exit 1; fi
         tar xf "${MPV_SYSROOT_TARBALL}";

         BASE_DIR="$(pwd)";
         SYSROOT_PATH="${BASE_DIR}/mpv_sysroot";
         export PKG_CONFIG_PATH="${SYSROOT_PATH}/lib/pkgconfig";

         for pc_file in $(find mpv_sysroot -iname '*.pc'); do
           sed -i "s+^prefix\s*=.*+prefix=${SYSROOT_PATH}+g" "${pc_file}";
           sed -i 's+^libdir\s*=.*+libdir=${prefix}/lib+g' "${pc_file}";
           sed -i 's+^includedir\s*=.*+includedir=${prefix}/include+g' "${pc_file}";
         done
      fi
  - |
        if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
            if [[ "$TRAVIS_OSX_IMAGE" == "xcode9.2" ]]; then
                brew update
                pushd "/usr/local/Homebrew/Library/Taps/homebrew/homebrew-core"
                git checkout 55e02323812604add9a69bab8730319b9255a697
                popd
                brew install autoconf
                brew install automake
                brew install pkg-config
                brew install libtool
                brew install python
                brew install freetype
                brew install fribidi
                brew install little-cms2
                brew install luajit
                brew install libass
                brew install ffmpeg
            else
                brew link --overwrite python
            fi
        fi

before_cache:
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew cleanup -s ; fi

cache:
  directories:
    - $HOME/Library/Caches/Homebrew

script:
  - ./bootstrap.py
  - |
      if [ "$TRAVIS_OS_NAME" = "linux" ]; then
        python3 waf configure;
        python3 waf build;
      fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then ./ci/build-macos.sh; fi
after_failure: cat ./build/config.log
after_script: TOOLS/travis-rebuild-website

notifications:
  email: false
  irc:
    if: fork = false
    channels:
      - "irc.freenode.org#mpv-devel"
    on_success: change
    on_failure: always

addons:
  coverity_scan:
    project:
      name: "mpv-player/mpv"
      description: "Build submitted via Travis CI"
    notification_email: mpv-team@googlegroups.com
    build_command_prepend: "./bootstrap.py && ./waf configure"
    build_command:   "./waf build"
    branch_pattern: coverity_scan
